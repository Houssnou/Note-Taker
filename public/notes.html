<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css">
  <link rel="stylesheet" href="style.css">
  <title>Home|Note Taker</title>
</head>

<body>
  <!-- nav bar  -->
  <nav class="navbar navbar-expand-lg navbar-light bg-primary">
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="./">Note Taker <span class="sr-only">(current)</span></a>
        </li>

      </ul>
      <form class="form-inline my-2 my-lg-0">
        <input class="form-control mr-sm-2" type="search" placeholder="coming soon" aria-label="Search">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search </button>
      </form>
    </div>
  </nav>
  <!-- end nav bar -->
  <!-- jumbotron for the accordion-->
  <div class="container my-4">
    <!-- New Note Form -->
    <div class="card mb-4 border-dark">
      <div class="card-header bg-dark text-light">
        What do you have in mind
      </div>
      <div class="card-body border-dark">
        <form role="form">
          <div class="form-group">
            <input type="text" class="form-control" id="title-input" placeholder="Note Title">
          </div>

          <div class="form-group">
            <textarea class="form-control" id="content-input" rows="2" placeholder="Save what your mind"></textarea>
          </div>
          <div class="form-group text-right">
            <button class="btn btn-outline-primary btn-sm" id="add-note" type="submit">Save</button>
            <button class="btn btn-outline-secondary btn-sm" id="reset-note" type="reset">Reset</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Accordion -->
    <div class="accordion" id="accordion">
      <!--  <div class="card">
        <div class="card-header " id="headingOne">
            <div class="row align-items-center">
            <div class="col-2 d-flex align-content-start">
            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#note1" aria-expanded="true"
              aria-controls="note1" style="color: black; font-weight: bold; text-decoration: none">
              Note 1
            </button>
          </div>
          <div class="col-8 d-flex align-content-start">
            Created: xxxx-xx-xx 00:00:00 Last modification: xxxx-xx-xx 00:00:00
          </div>
          <div class="col-2 d-flex justify-content-end">
            <i class="fas fa-edit"></i>
            <i class="fas fa-trash-alt"></i>
          </div>
        </div>
        </div>

        <div id="note1" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion">
          <div class="card-body">
            Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. 3 wolf moon
            officia aute, non cupidatat skateboard dolor brunch. 
          </div>
        </div>
      </div>  -->


    </div>

  </div>
  <!-- end jumbotron -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.13.0/umd/popper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js"></script>

  <script type="text/javascript">
    // on load display all notes from db
    //build the content of our accordion 
    //ajax call 
    // call the API tables
    $.ajax({
        url: "/api/notes",
        method: "GET"
      })
      .then(function (notes) {
        console.log(notes);
        notes.forEach((note, index) => {
          //accordion is just a card with header and body so lets have fun.
          //lets create an object noteObj that contains all the note[i] info
          const noteObj = {
            id: note.id,
            title: note.title,
            content: note.content,
            created: moment(note.date_creation).format("YYYY-MM-DD h:mm:ss a"),
            updated: moment(note.last_modification).format("YYYY-MM-DD h:mm:ss a")
          }
          //build the card
          const $card = $("<card>");

          //the header
          const $cardheader = $(`<div class='card-header text-align' id='heading${index+1}'>`);
          //div row to wrap the line : title dates actions
          //inside the header we will have a row with 3colums 2-8-2
          const $row = $("<div class='row align-items-center'>");
          const $colTitle = $("<div class='col-2 d-flex align-content-start'>");
          const $colDates = $("<div class='col-8 d-flex align-content-start'>");
          const $colActions = $("<div class='col-2 d-flex justify-content-end'>");



          //inline style to be removed later #collapse-link {color: black; font-weight: bold; text-decoration: none;
          //button to make the title clikable
          const $buttonTitle = $(
            `<button class='btn btn-link' type='button' 
                              data-toggle='collapse' data-target='#note${index+1}'
                              aria-expanded='false' aria-controls='note${index+1}'
                              style='color: black; font-weight: bold; text-decoration: none'>`
          ).text(note.title).appendTo($colTitle);

          //build the line //build the line: Note 1 created: modified edit and suppress icon 
          const $spanCreated = $("<span>").text(
            `Created :${moment(note.date_creation).format("YYYY-MM-DD H:MM:SS a")} `).appendTo($colDates);
          const $spanModified = $("<span>").text(
            `- Last Access :${moment(note.last_modification).format("YYYY-MM-DD H:MM:SS a")}`).appendTo(
            $colDates);

          //$("<i class='fas fa-edit'>")
          const $update = $("<i class='fas fa-edit text-warning'>").appendTo($colActions);
          const $delete = $("<button class='fas fa-trash-alt text-danger'>").appendTo($colActions);

          //link the data to the button to be able to use it on click on the button
          $update
            .attr("id", "update")
            .attr("data-toggle", "modal")
            .attr("data-target", "#update-modal");

          $delete
            .attr("id", "delete")
            .attr("data-toggle", "modal")
            .attr("data-target", "#delete-modal");

          // Using the data method to append more data 
          $update.data("data-note", note);
          $delete.data("data-note", note);

          //append them to the 
          //$cardheader.append($buttonTitle, $spanCreated, $spanModified, $update, $delete);
          $row.append($colTitle,$colDates,$colActions);
          $cardheader.append($row);

          //the body
          const $divCollapse = $(
            `<div id='note${index+1}' aria-labelledby='heading${index+1}' data-parent='#accordion'>`);

          //quick check to determine if it should be a class collapse show or not        
          (index === 0) ? $divCollapse.addClass("collapse show"): $divCollapse.addClass("collapse");

          const $cardBody = $("<div class='card-body'>");
          $cardBody.text(note.content).appendTo($divCollapse);

          //build the card content
          $card.append($cardheader, $divCollapse).appendTo("#accordion");
        });
      });

    //event listener for a click on submit
    $("#add-note").on("click", (event) => {
      //avoid reload page
      event.preventDefault();

      //build an object newNote with the input values and auto generate the creation and modification date using moment()
      const newNote = {
        title: $("#title-input").val().trim(),
        content: $("#content-input").val().trim(),
        date_creation: moment().format("YYYY-MM-DD HH:MM:SS"),
        last_modification: moment().format("YYYY-MM-DD HH:MM:SS")
      };
      console.log(newNote);
      //ajax call
      $.ajax({
        url: "/api/notes",
        method: "POST",
        data: newNote
      }).then(data => {
        //inform the user
        alert("Note Saved Successfully!");
        //then clear form inputs
        $("#title-input").val("");
        $("#content-input").val("");
        //reload the page
        location.reload();
      });
    });

    //listener for a click on action icon update
    $(document).on("click", "#update", function () {
      //get the values back from the data ()
      const updateNote= $(this).data("data-note");

      console.log(updateNote);

      //repopulate the form inputs.
      $("#title-input").val(updateNote.title);
      $("#content-input").val(updateNote.content);

    });

    //listener for a click on action icon delete
    $(document).on("click", "#delete", function () {
      //get the values back from the data ()
      const deleteNote= $(this).data("data-note");

      console.log(deleteNote);

      //call ajax /api/delete
      $.ajax({
        url: "/api/delete",
        method: "POST",
        data: deleteNote
      }).then(data => {

        //inform the user
        alert("Note Successfully deleted!");        
        //reload the page
        location.reload();
      });
    });
  </script>
</body>

</html>